---
title: "Bayesian Metanalysis"
output: html_notebook
---


```{r setup}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(brms)
posterior_interval <- 0.95
posterior_interval_bounds <- c(0.5 * (1 - posterior_interval), 1 - (0.5 * (1 - posterior_interval)))

intercept_prior <- prior(normal(0,2), class = Intercept)
sd_prior <- prior(normal(0,2), class = sd)
            

```

```{r}
convert_czech_numeric <- function(column) {
  result <- as.numeric(gsub(",",".", column, fixed = TRUE))
  if(any(is.na(result) != is.na(column))) {
    stop("Problem converting")
  }
  result
}

data <- read_excel(here("private_data","--META-DATA-5.xlsx"), sheet = "DATA 5") %>%
  rename(case_no = "source case n.", mut_nucl = "mu nucl", mut_amino = "principal mutation", mut_type = "mu-type", additional_mutation = "additional mutation", REPROD = "Reprod. organs abnorm") %>%
  select(source, case_no,gene, mut_nucl, mut_amino, mut_type, 
         Sex, Age, RD:speech) %>%
  mutate(CI = convert_czech_numeric(CI), DD = convert_czech_numeric(DD),
         LIV = convert_czech_numeric(LIV), REN = convert_czech_numeric(REN),
         REPROD = convert_czech_numeric(REPROD),
         Sex = factor(toupper(Sex)), 
         source = factor(source),
         gene = factor(gene))

data %>% skim()
```

```{r}
data %>% group_by(gene) %>% summarise(count = length(gene))
```


```{r}

data_long_all <- data %>% 
  rowid_to_column("ID") %>%  
  gather("phenotype","phenotype_value",RD:speech) 

data_long_all %>% group_by(phenotype) %>% summarise(count = sum(!is.na(phenotype_value)), prop = mean(phenotype_value, na.rm = TRUE))


phenotypes_to_use <- c("RD","OBE","PD","CI","REN","speech")
genes_to_use <- paste0("BBS",1:8)


data_long <- data_long_all %>%
  filter(phenotype %in% phenotypes_to_use, gene %in% genes_to_use) %>%
  filter(!is.na(phenotype_value)) %>%
  mutate(phenotype_value = as.integer(if_else(phenotype_value == 0, 0 , 1)))

data_long %>% group_by(gene, phenotype) %>% summarise(count = length(phenotype_value), prop = mean(phenotype_value))
```

# K vyreseni

TODO co s pulkami?

Druh korelace?
Formula 1 + (0+gene)|phenotype - korelace je 8x8, tj. vliv na renalni dispatii je korelovany mezi geny (což nechceme)

Pohlavi vyresit pres studii?

Zahrnout mensi geny/fenotypy?

Co dvojí mutace?

Koncept "kdybychom udelali dalsi studii, tak uvidime..."

# Gene only

```{r}
formula_gene_only <- brmsformula(phenotype_value ~ 1 + (0 + phenotype)|gene , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_only <- brm(formula_gene_only, prior = priors, data = data_long , control = list(adapt_delta = 0.9))
fit_gene_only
```


```{r}
run_pp_checks <- function(fit, data_long, out_func = print) {
  pp_check(fit, "bars", prob = posterior_interval, fatten = 1.5, freq = FALSE) %>% out_func
  pp_check(fit, "bars_grouped", group = "gene", prob = posterior_interval, fatten = 1.5, freq = FALSE)%>% out_func
  pp_check(fit, "bars_grouped", group = "phenotype", prob = posterior_interval, fatten = 1.5, freq = FALSE)%>% out_func
  
  predicted <- posterior_predict(fit) 
  sex_fct <- factor(if_else(is.na(data_long$Sex), "NA", as.character(data_long$Sex)))
  ppc_bars_grouped(data_long$phenotype_value, predicted, group = sex_fct, prob = posterior_interval, fatten = 1.5, freq = FALSE) %>% out_func
  ppc_bars_grouped(data_long$phenotype_value, predicted, group = interaction(sex_fct, data_long$phenotype) , prob = posterior_interval, fatten = 1.5, freq = FALSE) %>% out_func

}

plot_gene_phenotype_estimates <- function(fit, data_for_prediction) {
  estimates <- fitted(fit, data_for_prediction, allow_new_levels = TRUE, probs = posterior_interval_bounds, robust = TRUE)
  
  
  data_with_prediction <- data_for_prediction %>%
    cbind(as.tibble(estimates))
  data_with_prediction$lower <- data_with_prediction[,paste0("Q",posterior_interval_bounds[1] * 100)]
  data_with_prediction$upper <- data_with_prediction[,paste0("Q",posterior_interval_bounds[2] * 100)]
  
  data_with_prediction %>% ggplot(aes(x = gene, y = Estimate, ymin = lower, ymax = upper, color = gene)) + geom_pointrange() + facet_wrap(~phenotype)  
}
```

```{r}
run_pp_checks(fit_gene_only, data_long)
```

```{r}
plot_gene_phenotype_estimates(
  fit_gene_only,
  tibble(gene = genes_to_use) %>%
    crossing(tibble(phenotype = phenotypes_to_use)) 
  )

```

# Source

```{r}
formula_gene_source <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9))
fit_gene_source
run_pp_checks(fit_gene_source, data_long)
```

```{r}
data_for_prediction_gene_source <- tibble(gene = genes_to_use, source = "new_source") %>%
    crossing(tibble(phenotype = phenotypes_to_use))

plot_gene_phenotype_estimates(
  fit_gene_source, data_for_prediction_gene_source
  )



```
```{r}
plot_gene_phenotype_differences_estimates <- function(fit, data_for_prediction) {
  fitted_detailed <- fitted(fit, data_for_prediction, summary = FALSE, allow_new_levels = TRUE)

  samples_tidy <- data_for_prediction %>% 
    cbind(as.tibble(t(fitted_detailed))) %>%
    gather("sample","value", V1:V4000) 
    
  per_phenotype_and_sample_average <- samples_tidy %>%
    group_by(sample, phenotype) %>% 
    summarise(avg = mean(value))
  
  data_to_plot <- samples_tidy %>% 
    inner_join(per_phenotype_and_sample_average, by = c("phenotype" = "phenotype", "sample" = "sample")) %>%
    mutate(relative = value - avg) %>%
    group_by(phenotype, gene) %>%
    summarise(Estimate = median(relative), 
              lower = quantile(relative, posterior_interval_bounds[1]),
              upper = quantile(relative, posterior_interval_bounds[2]),
              lower50 = quantile(relative, 0.25),
              upper50 = quantile(relative, 0.75)
              )
  
  data_to_plot %>% ggplot(aes(x = gene, y = Estimate, ymin = lower, ymax = upper, color = gene)) +
    geom_hline(yintercept = 0, color = "darkred")+ 
    geom_linerange(aes(ymin = lower50, ymax = upper50), size = 2) +
    geom_linerange() + facet_wrap(~phenotype, scales = "free_y")  
}
```
```{r}
plot_gene_phenotype_differences_estimates(fit_gene_source, data_for_prediction_gene_source)
```

# Source, no phenotype correlations

```{r}
formula_gene_source_nocor <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)||gene) + ((0 + phenotype)||source) , family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_nocor <- brm(formula_gene_source_nocor, prior = priors, data = data_long, control = list(adapt_delta = 0.9))
fit_gene_source_nocor
run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_nocor, data_for_prediction_gene_source)
```

# Source & Sex - Filtered

```{r}
data_long_with_sex <- data_long %>% filter(!is.na(Sex)) %>% droplevels()

formula_gene_source_sex <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source_sex <- brm(formula_gene_source_sex, prior = priors, data = data_long_with_sex, control = list(adapt_delta = 0.9))
fit_gene_source_sex
run_pp_checks(fit_gene_source_sex, data_long_with_sex)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "M"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "F"))

```

# Source & Sex - NA separate

```{r}
data_long_with_sex_NA <- data_long %>% mutate(Sex = if_else(is.na(Sex), "NA", as.character(Sex)) %>% factor)

formula_gene_source_sex_NA <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source_sex_NA <- brm(formula_gene_source_sex_NA, prior = priors, data = data_long_with_sex_NA, control = list(adapt_delta = 0.95))
fit_gene_source_sex_NA
run_pp_checks(fit_gene_source_sex_NA, data_long_with_sex_NA)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "M"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "F"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "NA"))

```

The model:
Individual phenotypes are predicted by:
  * The mutated subdomain (hierarchical)
    * Possibly a hierarchical effect of the specific mutation
  * Sex
  * Study (hierarchical)

TODO: Figure out a way to make phenotypes correlated - maybe have hierarchical MVN priors for the coeffs?