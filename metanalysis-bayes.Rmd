---
title: "Bayesian Metanalysis"
output: html_notebook
---

TODO: 
- pp check for individual mutations
- vyfiltrovat, ktere pp check provadet
- individual dif per phenotype - spojit do jednoho plotu
- vazit jen k zobrazenym
- 8 fenotypu  (+ reproductive, heart)
- line range základní - sumarizovat pres funkcni skupiny, brát, "náhodnou mutaci pro pacienta", pak jen BBSome
- osy nechat zvlášt pro fenotyp
- stejně popisovat osy (stejný formát čísla)
- obarvit dle funkčních skupin (i když je jen jedna skupina) + zvýraznit rozdíly mimo 0
- vše na odds ratio
- dodat obrázky do 19. 10.

linerange: barva pro ty, co nepreshauji 0
- srovnani pheno po radcich je prehlednejsi
- podivat se na "divne" geny (případně vyhodit)

Text:
- Upravit text o filtraci (vyrazene fenotypy) - nebo spustit jeste nekdy se vsemi feno...

- korelace 4-8



```{r setup}
library(rstan)
library(brms)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(mice)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(cowplot)

posterior_interval <- 0.95
posterior_interval_bounds <- c(0.5 * (1 - posterior_interval), 1 - (0.5 * (1 - posterior_interval)))

#The sourced code refers to the above global variables, so has to be here (sorry for the mess)
source(here("plots.R"))


intercept_prior <- prior(normal(0,2), class = Intercept)
sd_prior <- prior(normal(0,2), class = sd)
            
stored_fits_dir <- "stored_fits"
if(!dir.exists(here(stored_fits_dir))) {
  dir.create(here(stored_fits_dir))
}
```

```{r}
convert_czech_numeric <- function(column) {
  result <- as.numeric(gsub(",",".", column, fixed = TRUE))
  if(any(is.na(result) != is.na(column))) {
    stop("Problem converting")
  }
  result
}


functional_group_for_gene <- function(gene) {
  case_when(
             gene %in% sprintf("BBS%02d",c(1,2,4,5,7,8,9,18)) ~ "BBSome",
             gene == "BBS03" ~ "BBS03",
             gene %in% sprintf("BBS%02d",c(6,10,12)) ~ "Chaperonins",
             TRUE ~ "Others"
           )
}

data <- read_excel(here("private_data","--META-DATA-5.xlsx"), sheet = "DATA 5") %>%
  rename(case_no = "source case n.", mut_nucl = "mu nucl", mut_amino = "principal mutation", mut_type = "mu-type", additional_mutation = "additional mutation", REPROD = "Reprod. organs abnorm") %>%
  select(source, case_no,gene, mut_nucl, mut_amino, mut_type, 
         Sex, Age, RD:speech) %>%
  mutate(CI = convert_czech_numeric(CI), DD = convert_czech_numeric(DD),
         LIV = convert_czech_numeric(LIV), REN = convert_czech_numeric(REN),
         REPROD = convert_czech_numeric(REPROD),
         Sex = factor(toupper(Sex)), 
         source = factor(source)
         ) %>%
  rowid_to_column("ID") %>%  

  #Get age categories
  mutate(Age_corr = if_else(Age == "5 month", as.character(5/12), gsub(",",".", Age)),
         age_numbers = if_else(grepl("^[0-9]*\\.?[0-9]*$",Age_corr), Age_corr, NA_character_) %>% as.numeric(),
         age_group = factor(case_when(
           is.na(Age_corr) ~ NA_character_,
           !is.na(age_numbers) ~ 
             case_when(
               age_numbers < 10 ~ "0-9",
               age_numbers < 20 ~ "10-19",
               age_numbers < 30 ~ "20-29",
               age_numbers < 40 ~ "30-39",
               age_numbers < 50 ~ "40-49",
               age_numbers < 60 ~ "50-59",
               TRUE ~ "60+",
             ),
           TRUE ~ Age_corr
           ))
  ) %>%
  
  #Get age for simpler model where categories are translated
  mutate(age_numbers_groups_guessed = 
           case_when(
            !is.na(age_numbers) ~ age_numbers,
            is.na(Age_corr) ~ NA_real_,
            Age_corr == "0-9" ~ 5,
            Age_corr == "10-19" ~ 15,
            Age_corr == "20-29" ~ 25,
            Age_corr == "30-39" ~ 35,
            Age_corr == "40-49" ~ 45,
            Age_corr == "50-59" ~ 55,
            Age_corr == "60+" ~ 65
          ),
         age_std_for_model = (age_numbers_groups_guessed - mean(age_numbers_groups_guessed, na.rm=TRUE))/ sd(age_numbers_groups_guessed, na.rm = TRUE)
        ) %>%


  #Code BBS to help ordering
  mutate(gene = factor(gsub("BBS([0-9])$","BBS0\\1", gene))) %>%
  

  #Introduce functional groups
  mutate(functional_group = 
           functional_group_for_gene(gene) %>% factor()
         ) 

if(!all(is.na(data$Age) == is.na(data$age_group))) {
  stop("Error in age transforms")
}
if(!all(is.na(data$Age) == is.na(data$age_numbers_groups_guessed))) {
  stop("Error in age transforms")
}
if(!all(is.na(data$Age) == is.na(data$age_std_for_model))) {
  stop("Error in age transforms")
}
if(!(identical(suppressWarnings(as.numeric(data$Age_corr)), data$age_numbers))) {
  stop("Error in age transforms")
}

#For some reasone this cannot be done with dplyr
data$hyposmia_anosmia = data$`hyposmia/anosmia`
data$`hyposmia/anosmia` = NULL

```

```{r}
data %>% skim()
```

The groups we use
```{r}
data %>% select(gene, functional_group) %>% distinct() %>% group_by(functional_group) %>% summarise(genes = paste(gene, collapse = ","))
```



```{r}
data %>% group_by(gene) %>% summarise(count = length(gene))
```


```{r}
  phenotypes_to_use <- c("RD","OBE","PD","CI","REN","LIV","REPROD","HEART")

  phenotypes_to_show <- phenotypes_to_use
  genes_to_show <- data %>% select(gene,functional_group) %>% distinct() %>% filter(functional_group != c("Others"), !(gene %in% c("BBS18"))) %>% get("gene", .)


data_long_from_data  <- function(data) {
  data_long_all <- data %>% 
    gather("phenotype","phenotype_value",RD:speech) 
  
  data_long_all %>% group_by(phenotype) %>% summarise(count = sum(!is.na(phenotype_value)), prop = mean(phenotype_value, na.rm = TRUE))
  
  
  functional_groups_to_show <- data$functional_group %>% unique()
  
  data_long <- data_long_all %>%
    filter(phenotype %in% phenotypes_to_use) %>%
    filter(!is.na(phenotype_value)) %>%
    mutate(phenotype_value = as.integer(if_else(phenotype_value == 0, 0 , 1)))
  
  data_long  
}

data_long <- data_long_from_data(data)

data_long %>% group_by(gene, phenotype) %>% summarise(count = length(phenotype_value), prop = mean(phenotype_value))
```

# K vyreseni

TODO co s pulkami? - konflikt informací z různých studií - ignorovat

Druh korelace?
Formula 1 + (0+gene)|phenotype - korelace je 8x8, tj. vliv na renalni dispatii je korelovany mezi geny (což nechceme)
Je podivné, že je korelace RD a REN, když RD mají skoro všichni (ověřit, jestli to není problém)

Co dvojí mutace? - zatím ignorovoat

BBSom se ještě dělí na 1,2+7,4+8,5,9 (ale to ignorovat)

# Gene only

```{r}
formula_gene_only <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_only <- brm(formula_gene_only, prior = priors, data = data_long , control = list(adapt_delta = 0.95),
                     file = here(stored_fits_dir,"gene_only"))
fit_gene_only
```



```{r}
#run_pp_checks(fit_gene_only, data_long)
data_for_prediction_gene_only <- tibble(gene = genes_to_show) %>%
    crossing(tibble(phenotype = phenotypes_to_show))

plot_gene_phenotype_estimates(
  fit_gene_only,
  data_for_prediction_gene_only 
  )

plot_gene_phenotype_differences_estimates(fit_gene_only, data_for_prediction_gene_only, genes_to_show = genes_to_show)


```


# Source

```{r}
formula_gene_source <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source) , family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

#The file argument
fit_gene_source <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source"))
fit_gene_source
#run_pp_checks(fit_gene_source, data_long)
```

```{r}
data_for_prediction_gene_source <- tibble(gene = genes_to_show, source = "new_source") %>%
    crossing(tibble(phenotype = phenotypes_to_show))

data_for_prediction_gene_source_BBSome <- data_for_prediction_gene_source %>% filter(functional_group_for_gene(gene) == "BBSome", gene != "BBS18")

plot_gene_phenotype_estimates(
  fit_gene_source, data_for_prediction_gene_source %>% filter(gene %in% genes_to_show)
  )

```

```{r}
plot_gene_phenotype_differences_estimates(fit_gene_source, data_for_prediction_gene_source, genes_to_show = genes_to_show)

plot_pairwise_differences(fit_gene_source, data_for_prediction_gene_source_BBSome)
```

# Source, gene correlations

```{r}
formula_gene_source_genecor <- brmsformula(phenotype_value ~ 1 + ((0 + gene)|phenotype) + ((0 + phenotype)||source) , family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_genecor <- brm(formula_gene_source_genecor, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_genecor"))
fit_gene_source_genecor

for(to_show in genes_to_show) {
  if(to_show == "BBS12") {
    next
  }
  stanplot(fit_gene_source_genecor, pars = paste0("cor.*",to_show,".*(", paste0(genes_to_show, collapse = "|"),")"), type = "intervals", point_est = "none", prob_outer = posterior_interval) %>% print()
}
#run_pp_checks(fit_gene_source_genecor, data_long)
```

```{r}
plot_gene_phenotype_differences_estimates(fit_gene_source_genecor, data_for_prediction_gene_source, genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_genecor, data_for_prediction_gene_source_BBSome)

plot_pairwise_differences(fit_gene_source_genecor, data_for_prediction_gene_source_BBSome)

```

# Source, narrower priors

```{r}
priors <- c(prior(normal(0,1), class = Intercept), prior(normal(0,1), class = sd))

fit_gene_source_narrow <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_narrow"))
fit_gene_source_narrow
#run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source, genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

plot_pairwise_differences(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

```

# Source, very narrow priors

```{r}
priors <- c(prior(normal(0,0.1), class = Intercept), prior(normal(0,0.1), class = sd))

fit_gene_source_narrow <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_narrow"))
fit_gene_source_narrow
#run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source, genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

plot_pairwise_differences(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

```


# Source, wide priors

```{r}
priors <- c(prior(normal(0,5), class = Intercept), prior(normal(0,5), class = sd))

fit_gene_source_narrow <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_narrow"))
fit_gene_source_narrow
#run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source, genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

plot_pairwise_differences(fit_gene_source_narrow, data_for_prediction_gene_source_BBSome)

```

# Source, no phenotype correlations

```{r}
formula_gene_source_nocor <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)||gene) + ((0 + phenotype)||source) , family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_nocor <- brm(formula_gene_source_nocor, prior = priors, data = data_long, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_nocor"))
fit_gene_source_nocor
#run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_nocor, data_for_prediction_gene_source, genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_nocor, data_for_prediction_gene_source_BBSome)

plot_pairwise_differences(fit_gene_source_nocor, data_for_prediction_gene_source_BBSome)

```

# Source & Sex - Filtered

```{r}
data_long_with_sex <- data_long %>% filter(!is.na(Sex)) %>% droplevels()

formula_gene_source_sex <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source_sex <- brm(formula_gene_source_sex, prior = priors, data = data_long_with_sex, control = list(adapt_delta = 0.9),
                     file = here(stored_fits_dir,"gene_source_sex"))
fit_gene_source_sex
#run_pp_checks(fit_gene_source_sex, data_long_with_sex)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "M"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "F"))

```

# Imputation with mice

```{r}
predictor_matrix <- matrix(0, nrow = 2, ncol = ncol(data))
colnames(predictor_matrix) <- names(data)
predictor_matrix[, c("gene")] <- 1

mice_m = 5
data_mice <- mice(data, m = mice_m, blocks = list("age_std_for_model", "Sex"), predictorMatrix = predictor_matrix)
data_mice$loggedEvents %>% select(dep, meth, out) %>% distinct()

data_long_mice <- mice::complete(data_mice, "all") %>% map(data_long_from_data)
```


# Source & Sex - Imputed

```{r}
priors <- c(intercept_prior, sd_prior)


fit_gene_source_sex_imputed <- brm_multiple(formula_gene_source_sex, prior = priors, data = data_long_mice, control = list(adapt_delta = 0.95),
                     file = here(stored_fits_dir,"gene_source_sex_imputed"))
fit_gene_source_sex_imputed
#run_pp_checks(fit_gene_source_sex_imputed, data_long_mice[[1]])
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_imputed, data_for_prediction_gene_source %>% mutate(Sex = "M"), genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_imputed, data_for_prediction_gene_source %>% mutate(Sex = "F"), genes_to_show = genes_to_show)

plot_pairwise_differences(fit_gene_source_sex_imputed, data_for_prediction_gene_source_BBSome %>% crossing(tibble(Sex = c("M","F"))))

```


# Source + Age imputed

There are `r sum(is.na(data$age_numbers) & !is.na(data$Age))` rows that only have age category. We have guessed the middle of the respective category to keep the model simple.


```{r}
formula_gene_source_age <- brmsformula(phenotype_value ~ 1 + ((0 + gene)|phenotype) + (0 + age_std_for_model + source||phenotype), family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_age_imputed <- brm_multiple(formula_gene_source_age, prior = priors, data = data_long_mice, control = list(adapt_delta = 0.95),
                     file = here(stored_fits_dir,"gene_source_age_imputed"))
fit_gene_source_age_imputed

#run_pp_checks(fit_gene_source_age_imputed, data_long_mice[[1]])

age_transform <- function(x) {
  (x - mean(data$age_numbers_groups_guessed, na.rm=TRUE))/ sd(data$age_numbers_groups_guessed, na.rm = TRUE)
}

plot_gene_phenotype_differences_estimates(fit_gene_source_age_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(10)), genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_age_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(30)), genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_age_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(50)), genes_to_show = genes_to_show)

plot_pairwise_differences(fit_gene_source_age_imputed, data_for_prediction_gene_source_BBSome %>% crossing(age_std_for_model = age_transform(c(10,30,50))))

```

```{r}
formula_gene_source_age_sex <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) + (0 + age_std_for_model||phenotype), family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_age_sex_imputed <- brm_multiple(formula_gene_source_age_sex, prior = priors, data = data_long_mice, control = list(adapt_delta = 0.95),
                     file = here(stored_fits_dir,"gene_source_age_sex_imputed"))
fit_gene_source_age_sex_imputed

#run_pp_checks(fit_gene_source_age_sex_imputed, data_long_mice[[1]])

plot_gene_phenotype_differences_estimates(fit_gene_source_age_sex_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(10), sex = "M"), genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_age_sex_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(30), sex = "F"), genes_to_show = genes_to_show)
plot_gene_phenotype_differences_estimates(fit_gene_source_age_sex_imputed, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_std_for_model = age_transform(50), sex = "F"), genes_to_show = genes_to_show)

plot_pairwise_differences(fit_gene_source_age_sex_imputed, data_for_prediction_gene_source_BBSome %>% crossing(tibble(Sex = c("M","F"))) %>% crossing(age_std_for_model = age_transform(c(10,30,50))))

```

```{r}
sessionInfo()
```

