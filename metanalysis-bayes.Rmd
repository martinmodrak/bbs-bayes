---
title: "Bayesian Metanalysis"
output: html_notebook
---


```{r setup}
library(rstan)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(brms)
posterior_interval <- 0.95
posterior_interval_bounds <- c(0.5 * (1 - posterior_interval), 1 - (0.5 * (1 - posterior_interval)))

intercept_prior <- prior(normal(0,2), class = Intercept)
sd_prior <- prior(normal(0,2), class = sd)
            

```

```{r}
convert_czech_numeric <- function(column) {
  result <- as.numeric(gsub(",",".", column, fixed = TRUE))
  if(any(is.na(result) != is.na(column))) {
    stop("Problem converting")
  }
  result
}


functional_group_for_gene <- function(gene) {
  case_when(
             gene %in% sprintf("BBS%02d",c(1,2,4,5,7,9,18)) ~ "BBSome",
             gene == "BBS03" ~ "BBS03",
             gene %in% sprintf("BBS%02d",c(6,10,12)) ~ "Chaperonins",
             TRUE ~ "Others"
           )
}

data <- read_excel(here("private_data","--META-DATA-5.xlsx"), sheet = "DATA 5") %>%
  rename(case_no = "source case n.", mut_nucl = "mu nucl", mut_amino = "principal mutation", mut_type = "mu-type", additional_mutation = "additional mutation", REPROD = "Reprod. organs abnorm") %>%
  select(source, case_no,gene, mut_nucl, mut_amino, mut_type, 
         Sex, Age, RD:speech) %>%
  mutate(CI = convert_czech_numeric(CI), DD = convert_czech_numeric(DD),
         LIV = convert_czech_numeric(LIV), REN = convert_czech_numeric(REN),
         REPROD = convert_czech_numeric(REPROD),
         Sex = factor(toupper(Sex)), 
         source = factor(source)
         ) %>%
  rowid_to_column("ID") %>%  

  #Get age categories
  mutate(Age_corr = if_else(Age == "5 month", as.character(5/12), gsub(",",".", Age)),
         age_numbers = if_else(grepl("^[0-9]*\\.?[0-9]*$",Age_corr), Age_corr, NA_character_) %>% as.numeric(),
         age_group = factor(case_when(
           is.na(Age_corr) ~ NA_character_,
           !is.na(age_numbers) ~ 
             case_when(
               age_numbers < 10 ~ "0-9",
               age_numbers < 20 ~ "10-19",
               age_numbers < 30 ~ "20-29",
               age_numbers < 40 ~ "30-39",
               age_numbers < 50 ~ "40-49",
               age_numbers < 60 ~ "50-59",
               TRUE ~ "60+",
             ),
           TRUE ~ Age_corr
           ))
  ) %>%
  
  #Get age for simpler model where categories are translated
  mutate(age_numbers_groups_guessed = 
           case_when(
            !is.na(age_numbers) ~ age_numbers,
            is.na(Age_corr) ~ NA_real_,
            Age_corr == "0-9" ~ 5,
            Age_corr == "10-19" ~ 15,
            Age_corr == "20-29" ~ 25,
            Age_corr == "30-39" ~ 35,
            Age_corr == "40-49" ~ 45,
            Age_corr == "50-59" ~ 55,
            Age_corr == "60+" ~ 65
          ),
         age_std_for_model = (age_numbers_groups_guessed - mean(age_numbers_groups_guessed, na.rm=TRUE))/ sd(age_numbers_groups_guessed, na.rm = TRUE)
        ) %>%


  #Code BBS to help ordering
  mutate(gene = factor(gsub("BBS([0-9])$","BBS0\\1", gene))) %>%
  

  #Introduce functional groups
  mutate(functional_group = 
           functional_group_for_gene(gene) %>% factor()
         ) 

if(!all(is.na(data$Age) == is.na(data$age_group))) {
  stop("Error in age transforms")
}
if(!all(is.na(data$Age) == is.na(data$age_numbers_groups_guessed))) {
  stop("Error in age transforms")
}
if(!all(is.na(data$Age) == is.na(data$age_std_for_model))) {
  stop("Error in age transforms")
}
if(!(identical(suppressWarnings(as.numeric(data$Age_corr)), data$age_numbers))) {
  stop("Error in age transforms")
}

```

```{r}
data %>% skim()
```

The groups we use
```{r}
data %>% select(gene, functional_group) %>% distinct() %>% group_by(functional_group) %>% summarise(genes = paste(gene, collapse = ","))
```



```{r}
data %>% group_by(gene) %>% summarise(count = length(gene))
```


```{r}

data_long_all <- data %>% 
  gather("phenotype","phenotype_value",RD:speech) 

data_long_all %>% group_by(phenotype) %>% summarise(count = sum(!is.na(phenotype_value)), prop = mean(phenotype_value, na.rm = TRUE))


phenotypes_to_use <- c("RD","OBE","PD","CI","REN","LIV")
genes_to_show <- data %>% select(gene,functional_group) %>% distinct() %>% filter(functional_group != c("Others"), !(gene %in% c("BBS18"))) %>% get("gene", .)
functional_groups_to_show <- data$functional_group %>% unique()

data_long <- data_long_all %>%
  filter(phenotype %in% phenotypes_to_use) %>%
  filter(!is.na(phenotype_value)) %>%
  mutate(phenotype_value = as.integer(if_else(phenotype_value == 0, 0 , 1)))

data_long %>% group_by(gene, phenotype) %>% summarise(count = length(phenotype_value), prop = mean(phenotype_value))
```

# K vyreseni

TODO co s pulkami? - konflikt informací z různých studií - ignorovat

Druh korelace?
Formula 1 + (0+gene)|phenotype - korelace je 8x8, tj. vliv na renalni dispatii je korelovany mezi geny (což nechceme)
Skupiny genů - v materiálech, zvážit, jestli nezahrnout.
Korelace genů nás taky zajímají
Je podivné, že je korelace RD a REN, když RD mají skoro všichni (ověřit, jestli to není problém)

Zahrnout mensi geny/fenotypy?
Zajímavý je LIV (viz pptx)

Co dvojí mutace? - zatím ignorovoat

Koncept "kdybychom udelali dalsi studii, tak uvidime..."

Missingness fenotypu, veku, pohlavi - at random?

Respektovat strukturu skupin (functional groups):
- BBSome: 1,2,4,5,7,9, (18 - jen jeden pacient)
- 3
- Chaperonins: 6,10,12
- Others

BBSom se ještě dělí na 1,2+7,4+8,5,9 (ale to ignorovat)

Vymyslet vizualizaci pro párové porovnání

# Gene only

```{r}
formula_gene_only <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)||gene / functional_group) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_only <- brm(formula_gene_only, prior = priors, data = data_long , control = list(adapt_delta = 0.95))
fit_gene_only
```


```{r}
my_ppc <- function(fun, ...) {
  fun(..., prob = posterior_interval, fatten = 1.5, freq = FALSE)
}

my_ppc_bars <- function(...) {
  my_ppc(ppc_bars, ...)
}

my_ppc_bars_grouped <- function(...) {
  my_ppc(ppc_bars_grouped, ...)
}

run_pp_checks <- function(fit, data_long, out_func = print) {
  
  predicted <- posterior_predict(fit) 

  
  my_ppc_bars(data_long$phenotype_value, predicted) %>% out_func
  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = data_long$gene) %>% out_func
  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = data_long$phenotype) %>% out_func

  sex_fct <- factor(if_else(is.na(data_long$Sex), "NA", as.character(data_long$Sex)))
  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = sex_fct) %>% out_func
  
  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = interaction(sex_fct, data_long$phenotype)) %>% out_func
  

  age_fct <- factor(if_else(is.na(data_long$age_group), "NA", as.character(data_long$age_group)))
  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = age_fct) %>% out_func

  my_ppc_bars_grouped(data_long$phenotype_value, predicted, group = interaction(age_fct, data_long$phenotype)) %>% out_func
  
}

plot_gene_phenotype_estimates <- function(fit, data_for_prediction) {
  estimates <- fitted(fit, data_for_prediction, allow_new_levels = TRUE, probs = posterior_interval_bounds, robust = TRUE)
  estimates50 <- fitted(fit, data_for_prediction, allow_new_levels = TRUE, probs = c(0.25,0.75), robust = TRUE)
  
  
  data_with_prediction <- data_for_prediction %>%
    cbind(as.tibble(estimates)) %>% cbind(as.tibble(estimates50) %>% select(Q25,Q75)) 
  
  data_with_prediction$lower <- data_with_prediction[,paste0("Q",posterior_interval_bounds[1] * 100)]
  data_with_prediction$upper <- data_with_prediction[,paste0("Q",posterior_interval_bounds[2] * 100)]
  
  data_with_prediction %>% ggplot(aes(x = gene, y = Estimate, ymin = lower, ymax = upper, color = functional_group)) +
    geom_linerange() + 
    geom_linerange(aes(ymin = Q25, ymax = Q75), size = 2) +
    facet_wrap(~phenotype)  +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

}

plot_functional_group_phenotype_estimates <- function(fit, data_for_prediction) {
  estimates <- fitted(fit, data_for_prediction, allow_new_levels = TRUE, sample_new_levels = "old_levels", probs = posterior_interval_bounds, robust = TRUE)
  estimates50 <- fitted(fit, data_for_prediction, allow_new_levels = TRUE, sample_new_levels = "old_levels", probs = c(0.25,0.75), robust = TRUE)
  
  
  data_with_prediction <- data_for_prediction %>%
    cbind(as.tibble(estimates)) %>% cbind(as.tibble(estimates50) %>% select(Q25,Q75)) 
  
  data_with_prediction$lower <- data_with_prediction[,paste0("Q",posterior_interval_bounds[1] * 100)]
  data_with_prediction$upper <- data_with_prediction[,paste0("Q",posterior_interval_bounds[2] * 100)]
  
  data_with_prediction %>% ggplot(aes(x = functional_group, y = Estimate, ymin = lower, ymax = upper, color = functional_group)) +
    geom_linerange() + 
    geom_linerange(aes(ymin = Q25, ymax = Q75), size = 2) +
    facet_wrap(~phenotype)  +
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

}

```

```{r}
#run_pp_checks(fit_gene_only, data_long)

plot_functional_group_phenotype_estimates(
  fit_gene_only,
  tibble(functional_group = functional_groups_to_show) %>%
    crossing(tibble(phenotype = phenotypes_to_use)) %>%
    mutate(gene = "random_gene")
  )


plot_gene_phenotype_estimates(
  fit_gene_only,
  tibble(gene = genes_to_show) %>%
    mutate(functional_group = functional_group_for_gene(gene)) %>%
    crossing(tibble(phenotype = phenotypes_to_use)) 
  )


```


# Source

```{r}
formula_gene_source <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source <- brm(formula_gene_source, prior = priors, data = data_long, control = list(adapt_delta = 0.9))
fit_gene_source
run_pp_checks(fit_gene_source, data_long)
```

```{r}
data_for_prediction_gene_source <- tibble(gene = genes_to_use, source = "new_source") %>%
    crossing(tibble(phenotype = phenotypes_to_use))

plot_gene_phenotype_estimates(
  fit_gene_source, data_for_prediction_gene_source
  )



```
```{r}
plot_gene_phenotype_differences_estimates <- function(fit, data_for_prediction) {
  fitted_detailed <- fitted(fit, data_for_prediction, summary = FALSE, allow_new_levels = TRUE)

  samples_tidy <- data_for_prediction %>% 
    cbind(as.tibble(t(fitted_detailed))) %>%
    gather("sample","value", V1:V4000) 
    
  per_phenotype_and_sample_average <- samples_tidy %>%
    group_by(sample, phenotype) %>% 
    summarise(avg = mean(value))
  
  data_to_plot <- samples_tidy %>% 
    inner_join(per_phenotype_and_sample_average, by = c("phenotype" = "phenotype", "sample" = "sample")) %>%
    mutate(relative = value - avg) %>%
    group_by(phenotype, gene) %>%
    summarise(Estimate = median(relative), 
              lower = quantile(relative, posterior_interval_bounds[1]),
              upper = quantile(relative, posterior_interval_bounds[2]),
              lower50 = quantile(relative, 0.25),
              upper50 = quantile(relative, 0.75)
              )
  
  data_to_plot %>% ggplot(aes(x = gene, y = Estimate, ymin = lower, ymax = upper, color = gene)) +
    geom_hline(yintercept = 0, color = "darkred")+ 
    geom_linerange(aes(ymin = lower50, ymax = upper50), size = 2) +
    geom_linerange() + facet_wrap(~phenotype, scales = "free_y")  +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))
}
```
```{r}
plot_gene_phenotype_differences_estimates(fit_gene_source, data_for_prediction_gene_source)
```

# Source, no phenotype correlations

```{r}
formula_gene_source_nocor <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)||gene) + ((0 + phenotype)||source) , family = "bernoulli")

priors <- c(intercept_prior, sd_prior)

fit_gene_source_nocor <- brm(formula_gene_source_nocor, prior = priors, data = data_long, control = list(adapt_delta = 0.9))
fit_gene_source_nocor
run_pp_checks(fit_gene_source_nocor, data_long)
plot_gene_phenotype_differences_estimates(fit_gene_source_nocor, data_for_prediction_gene_source)
```

# Source & Sex - Filtered

```{r}
data_long_with_sex <- data_long %>% filter(!is.na(Sex)) %>% droplevels()

formula_gene_source_sex <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source_sex <- brm(formula_gene_source_sex, prior = priors, data = data_long_with_sex, control = list(adapt_delta = 0.9))
fit_gene_source_sex
run_pp_checks(fit_gene_source_sex, data_long_with_sex)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "M"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex, data_for_prediction_gene_source %>% mutate(Sex = "F"))

```

# Source & Sex - NA separate

```{r}
data_long_with_sex_NA <- data_long %>% mutate(Sex = if_else(is.na(Sex), "NA", as.character(Sex)) %>% factor)

formula_gene_source_sex_NA <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source + Sex) , family = "bernoulli")

#get_prior(formula_gene_only, data = data_long)
priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_only, data_long, prior = priors)

fit_gene_source_sex_NA <- brm(formula_gene_source_sex_NA, prior = priors, data = data_long_with_sex_NA, control = list(adapt_delta = 0.95))
fit_gene_source_sex_NA
run_pp_checks(fit_gene_source_sex_NA, data_long_with_sex_NA)
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "M"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "F"))
plot_gene_phenotype_differences_estimates(fit_gene_source_sex_NA, data_for_prediction_gene_source %>% mutate(Sex = "NA"))

```


```{r}
# formula_multi_gene <- brmsformula(cbind(CI,OBE,PD,RD,REN) ~ 1 + 1||gene, family = "bernoulli")
# 
# get_prior(formula_multi_gene, data = data)
# priors <- c(intercept_prior, sd_prior)
# 
# #make_stancode(formula_gene_only, data_long, prior = priors)
# 
# fit_multi_gene <- brm(formula_multi_gene, data = data, control = list(adapt_delta = 0.95))

```

# Source + Age as missing data

There are `r sum(is.na(data$age_numbers) & !is.na(data$Age))` rows that only have age category. We have guessed the middle of the respective category to keep the model simple.

The first model is incorrect - separately estimating missing age for each predictor described...

```{r}
data_long_age <- data_long %>% 
  mutate(age_mod = if_else(is.na(age_std_for_model), 0, age_std_for_model),
         guess_age = if_else(is.na(age_std_for_model), 1, 0),
         ID_for_age = factor(if_else(is.na(age_std_for_model),"No", as.character(ID)))
  ) 

formula_gene_source_age <- brmsformula(phenotype_value ~ 1 + ((0 + phenotype)|gene) + ((0 + phenotype)||source) + (0 + age_mod||phenotype) + (0 + guess_age || ID_for_age / phenotype) , family = "bernoulli")

get_prior(formula_gene_source_age, data =data_long_age)

priors <- c(intercept_prior, sd_prior)

#make_stancode(formula_gene_source_age, data_long, prior = priors)



fit_gene_source_age <- brm(formula_gene_source_age, prior = priors, data = data_long_age, control = list(adapt_delta = 0.95))
fit_gene_source_age

run_pp_checks(fit_gene_source_age, data_long_age)
plot_gene_phenotype_differences_estimates(fit_gene_source_age, data_for_prediction_gene_source %>% mutate(age_mod = 0, guess_age = 1))

age_transform <- function(x) {
  (x - mean(data$age_numbers_groups_guessed, na.rm=TRUE))/ sd(data$age_numbers_groups_guessed, na.rm = TRUE)
}

plot_gene_phenotype_differences_estimates(fit_gene_source_age, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_mod = age_transform(10), guess_age = 0))
plot_gene_phenotype_differences_estimates(fit_gene_source_age, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_mod = age_transform(30), guess_age = 0))
plot_gene_phenotype_differences_estimates(fit_gene_source_age, 
                                          data_for_prediction_gene_source %>% 
                                            mutate(age_mod = age_transform(50), guess_age = 0))

```


The model:
Individual phenotypes are predicted by:
  * The mutated subdomain (hierarchical)
    * Possibly a hierarchical effect of the specific mutation
  * Sex
  * Study (hierarchical)

TODO: 
pp check for individual mutations