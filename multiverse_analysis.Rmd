---
title: "Additional multiverse analysis"
output: html_notebook
---

TODO: 
- pp check for individual mutations
- vyfiltrovat, ktere pp check provadet
- individual dif per phenotype - spojit do jednoho plotu
- line range základní - sumarizovat pres funkcni skupiny, brát, "náhodnou mutaci pro pacienta", pak jen BBSome
- osy nechat zvlášt pro fenotyp
- obarvit dle funkčních skupin (i když je jen jedna skupina) + zvýraznit rozdíly mimo 0
- vše na odds ratio
- dodat obrázky do 19. 10.
- - korelace 4-8

- Rozdily v RD zmizi pri imputation Sex
- min_probable_OR ma divný scale

- srovnani pheno po radcich je prehlednejsi
- podivat se na "divne" geny (případně vyhodit)

Text:
- Upravit text o filtraci (vyrazene fenotypy) - nebo spustit jeste nekdy se vsemi feno...
- Extremely skeptical prior is required to make a small portion of the 95% intervals not



```{r setup}
library(rstan)
library(brms)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(mice)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(cowplot)

source(here("data_processing.R"))
source(here("models.R"))
source(here("models_funcs.R"))
source(here("plots.R"))

stored_fits_dir <- "stored_fits"
if(!dir.exists(here(stored_fits_dir))) {
  dir.create(here(stored_fits_dir))
}

```

```{r}
data <- read_main_data()
```


```{r}
genes_to_show <- genes_to_show_from_data(data)

data_long <- data_long_from_data(data)
```



```{r}
data_for_prediction_gene_only <- tibble(gene = genes_to_show) %>%
    crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))

data_for_prediction_gene_only_BBSome <- data_for_prediction_gene_only %>% filter(functional_group_for_gene(gene) == "BBSome", gene != "BBS18")


data_for_prediction_gene_source <- tibble(gene = genes_to_show, source = "new_source") %>%
    crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))

data_for_prediction_gene_source_BBSome <- data_for_prediction_gene_source %>% filter(functional_group_for_gene(gene) == "BBSome", gene != "BBS18")

data_long_filter_lof <- data_long %>% filter(loss_of_function == "certain")

data_for_prediction_gene_source_lof <- tibble(gene = genes_to_show, source = "new_source", loss_of_function_certain = 1) %>%
    crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))

plot_pairwise_differences(fit_gene_source_age_imputed, data_for_prediction_gene_source_BBSome %>% crossing(age_std_for_model = age_transform(c(10,30,50))))

plot_pairwise_differences(fit_gene_source_age_sex_imputed, data_for_prediction_gene_source_BBSome %>% crossing(tibble(Sex = c("M","F"))) %>% crossing(age_std_for_model = age_transform(c(10,30,50))))

```

```{r}


```

adapt_delta = 0.95




# Source + lof

TODO

In most cases, the loss of function does not make for a big difference in predictions. This is because there is no strong distinction in the data itself:

```{r, fig.width=8, fig.height=4}
lof_data_plot <- data_long %>% 
  group_by(source, phenotype, gene, loss_of_function) %>% 
  filter(functional_group == "BBSome", gene != "BBS18") %>%
  summarise(n_patients = length(phenotype_value), proportion = sum(phenotype_value) / n_patients) %>%
  ggplot(aes(x = gene, y = proportion, size = n_patients, color = loss_of_function)) +
  geom_jitter(alpha = 0.3, height = 0, width = 0.2) +
  facet_wrap(~phenotype, nrow = 2) +
  scale_y_continuous("Proportion of phenotype") +
  scale_size_continuous(range = c(0.5,4)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

lof_data_plot
```


# Imputation with mice

It is hard to im

```{r}
predictor_matrix <- matrix(0, nrow = 2, ncol = ncol(data))
colnames(predictor_matrix) <- names(data)

#For 

#predictor_matrix[, phenotypes_to_use] <- 1
predictor_matrix[, c("functional_group")] <- 1
predictor_matrix[1, c("Sex")] <- 1
predictor_matrix[2, c("age_std_for_model")] <- 1

mice_m = 5
data_mice <- mice(data, m = mice_m, blocks = list("age_std_for_model", "Sex"), predictorMatrix = predictor_matrix)
if(!is.null(data_mice$loggedEvents)) {
  data_mice$loggedEvents %>% select(dep, meth, out) %>% distinct()
}

data_long_mice <- mice::complete(data_mice, "all") %>% map(data_long_from_data)
```

```{r}
my_hist_func <- function(x) { ggplot(x, aes(x = age_std_for_model)) + geom_density(adjust = 2) + facet_wrap(~phenotype) + scale_y_continuous(limits = c(0,0.9)) }
data_long_mice %>% map(my_hist_func)

(data_long %>% filter(!is.na(age_std_for_model)) %>% my_hist_func) + ggtitle("Original")

```

```{r}
models_imputed <- list(
  gene_source_imputed_sex = list(formula = formula_gene_source_sex, priors = default_priors, components = c("gene", "source", "sex"), filter = c()),

  gene_source_imputed_age = list(formula = formula_gene_source_age, priors = default_priors, components = c("gene", "source", "age"), filter = c()),
  
  gene_source_imputed_age_sex = list(formula = brmsformula(update.formula(formula_gene_source, ~ . + (0 + age_std_for_model||phenotype)), family = "bernoulli"), priors = default_priors, components = c("gene", "source", "age", "sex"), filter = c())
)
```



```{r}
sessionInfo()
```

