---
title: "Appendix 3: Additional multiverse analysis of BBS phenotypes"
author: "Martin Modr√°k"
date: '`r format(Sys.time(), "%d %B, %Y")`'
abstract: 'This is an appendix for the paper "Exploring the function of the BBSome using clinical data: Meta-analysis of genotype-phenotype associations in Bardet-Biedl Syndrome". Here, we compute how the conclusions of the paper hold under multiple different models. Details of the models can be found in Appends 4. The complete source code for the analysis can be found at https://github.com/martinmodrak/bbs-metaanalysis-bayes'
output:
  pdf_document: default
---




*Note: For historical reasons the feature of "certain loss of function" (cLOF) as discussed in the data is called just "lof" in most analysis code. This appendix will thus use "lof" and "cLOF" interchangeably.*



```{r setup, echo=FALSE, message = FALSE}
knitr::opts_chunk$set(echo=FALSE, cache = TRUE)
library(rstan)
library(brms)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(mice)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(cowplot)

source(here("data_processing.R"))
source(here("models.R"))
source(here("models_funcs.R"))
source(here("plots.R"))

##PP Checks take time, so turn this off for quicker computation of the rest
compute_pp_checks <- TRUE
```

```{r}
data <- read_main_data()
genes_to_show <- genes_to_show_from_data(data)
```


```{r load_all_fits}
all_fits <- all_models %>% map(function(def) {
  stored_fit_file <- paste0(here(stored_fits_dir,def$name), ".rds")
  if(!file.exists(stored_fit_file)) {
    stop(paste0("Computed fit for model '", def$name,"' cannot be found at ", stored_fit_file, ".\nYou probably need to run alternative_models.Rmd to compute all fits"))
  }
  readRDS(stored_fit_file)
})
```

# Defining Precise Criteria

```{r}
min_interesting_effect <- 2
min_phenotypes_for_diffs <- 3
min_bbsome_pairwise_for_diffs <- 5

evaluators <- list()
```

There is some flexibility in defining the exact model configurations consistent with a given conclusion. In general, when speaking whether there is or isn't a difference, the Bayesian model will always say "yes there is a (possibly small) difference" - the posterior probability of a difference of exactly 0 is 0. Instead we choose a threshold of a "clinically relevant effect", which for us is odds ratio outside of (`r 1/min_interesting_effect`,`r min_interesting_effect`).

The exact definition of the individual conclusions follow.


```{r}
n_genes_lof_different <- 5
```

  *	The severity of BBS is worse in patients with LOF mutations than in patients with other mutations. 
    * Ignored for models that do not include LOF
    * Measured as posterior probability, that the LOF effect is positive (OR > 1) for at least `r n_genes_lof_different` BBSome genes in `r min_phenotypes_for_diffs` phenotypes.
```{r}

evaluator_lof <- function(def, fit) {
 if("lof" %in% def$additional_components || "lof per gene" %in% def$additional_components)  {
   # phenotype_coeffs <- paste0("phenotype", phenotypes_to_use,":loss_of_function_certain")
   # genes_to_check <- sprintf("BBS%02d",c(1,2,4,5,7,8,9))
   # samples_raw <- coef(fit, summary = FALSE)$gene[,genes_to_check,phenotype_coeffs]
   # #grid <- list(sample = 1:(dim(samples_raw)[1]), gene = genes_to_check, phenotype = phenotypes_to_use)
   # grid <- list(sample = 1:(dim(samples_raw)[1]), gene_id = 1:length(genes_to_check), phenotype_id = 1:length(phenotypes_to_use))
   # samples_tidy <- expand.grid(grid)
   #samples_tidy$lof_coef <- samples_raw[as.matrix(samples_tidy)]
   #  samples_tidy %>% mutate(gene = genes_to_check[gene_id], phenotype = phenotypes_to_use[phenotype_id])
   
   genes_to_check <- sprintf("BBS%02d",c(1,2,4,5,7,8,9))
   data_for_prediction_lof <- data_for_prediction_base_model(def, genes_to_check, phenotypes_to_show = phenotypes_to_show, age_transform = age_transform_from_age(data$age_numbers_groups_guessed))
   samples_tidy <- get_samples_lof_diff(fit, data_for_prediction_lof)
   
   samples_tidy %>% 
     group_by(sample, phenotype) %>% summarise(enough_genes = sum(odds_ratio > 1) >= n_genes_lof_different) %>%
     group_by(sample) %>% summarise(enough_phenotypes = sum(enough_genes) >= min_phenotypes_for_diffs) %>%
     ungroup() %>% summarise(`cLOF mutations more severe` = mean(enough_phenotypes))
 } else {
   tibble(`cLOF mutations more severe` = NA_real_)
 }
}
```
  
  *	The data suggest that BBS3 has lower severity than mutations in different functional groups of genes.
    * Measured as posterior probability, that odds ratio is < 1 for at least `r min_phenotypes_for_diffs` phenotypes for at least 1/2 of pairwise gene comparisons.
  
```{r}
evaluator_functional_groups_lower <- function(group1, group2) {
  function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
    target_column_name = paste(bbs_labeller(group1),"less severe than",bbs_labeller(group2))
    samples_diff %>% 
      filter(functional_group.x == group1, functional_group.y == group2) %>%
      group_by(sample, phenotype) %>%
      summarise(enough_pairwise_relevant = mean(odds_ratio < 1) >= 1/2) %>%
      group_by(sample) %>%
      summarise(enough_phenotype_relevant = sum(enough_pairwise_relevant) >= min_phenotypes_for_diffs) %>%
      ungroup() %>%
      summarise(!!target_column_name := mean(enough_phenotype_relevant))  
  }
}

evaluators[["bbs3_vs_bbsome"]] <- evaluator_functional_groups_lower("BBS03","BBSome")
evaluators[["bbs3_vs_chaperonins"]] <- evaluator_functional_groups_lower("BBS03","Chaperonins")
```
  *	The data suggest a difference between the severity of BBS in patients with mutations in different BBSome subunits.
    * Measured as posterior probability, that there is clinically relevant effect for at least `r min_phenotypes_for_diffs` phenotypes for at least `r min_bbsome_pairwise_for_diffs` pairwise comparisons. 
```{r}
evaluators[["bbsome_genes_differ"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
samples_diff_bbsome %>% 
  filter(as.character(gene.x) > as.character(gene.y)) %>%
  group_by(sample, phenotype) %>%
  summarise(enough_pairwise_relevant = sum(is_relevant) >= min_bbsome_pairwise_for_diffs) %>%
  group_by(sample) %>%
  summarise(enough_phenotype_relevant = sum(enough_pairwise_relevant) >= min_phenotypes_for_diffs)  %>%
  ungroup() %>%
  summarise(`BBSome genes differ` = mean(enough_phenotype_relevant))
}
```

```{r}
    # def <- models_base$gene_source
    # fit <- all_fits[[def$name]]
    # data_for_prediction <- data_for_prediction_base_model(def, genes_to_show, phenotypes_to_show, age_transform = age_transform_from_age(data$age_numbers_groups_guessed))
    # 
    # data_for_prediction_bbsome <- data_for_prediction %>% filter_for_BBSome()
    # 
    # samples <- get_tidy_samples(fit, data_for_prediction)
    # samples_diff <- get_samples_pairwise_diff(def, samples) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    # 
    # samples_diff_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome) %>% get_samples_pairwise_diff(def, .) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    # 
    # samples_prediction_bbsome = get_tidy_samples_prediction(fit, data_for_prediction_bbsome)
    # 
    # samples_linear_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome, scale = "linear")

```

  *	BBS4 phenotype is the most severe of all BBSome subunits.
    * Probability that BBS4 has top 3 odds ratios for at least 5 phenotypes
    * Probability that a patient with BBS4 has the most #phenotypes.
```{r}
evaluators[["bbs04_top"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
samples_diff_bbsome %>% 
  filter(gene.x == "BBS04", gene.y != "BBS04") %>%
  group_by(sample, phenotype) %>%
  summarise(bbs04_top = sum(odds_ratio < 1) <= 2) %>%
  group_by(sample) %>%
  summarise(bbs04_top_all = sum(bbs04_top) >= 5 ) %>%
  summarise(`BBS4 top odds` = mean(bbs04_top_all))
}
```
```{r}
evaluators[["bbs04_most_pheno"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
  samples_prediction_bbsome %>% 
    group_by(sample, gene) %>%
    summarise(num_phenotypes = sum(value)) %>%
    group_by(sample) %>%
    mutate(has_most_pheno = num_phenotypes >= max(num_phenotypes) ) %>%
    ungroup() %>%
    filter(gene == "BBS04") %>%
    #group_by(gene) %>%
    summarise(`BBS4 most #phenotypes` = mean(has_most_pheno))
}
```
  *	Mutations in different BBSome subunits predispose to different renal phenotype.
    *  Measured as posterior probability, that there is clinically relevant effect for at least `r min_bbsome_pairwise_for_diffs` pairwise comparisons. 
```{r}
evaluators[["REN_bbsome_genes_differ"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
  samples_diff_bbsome %>% 
    filter(phenotype == "REN", as.character(gene.x) > as.character(gene.y)) %>%
    group_by(sample) %>%
    summarise(enough_pairwise_relevant = sum(is_relevant) >= min_bbsome_pairwise_for_diffs) %>%
    ungroup() %>%
    summarise(`REN: BBSome genes differ` = mean(enough_pairwise_relevant))
}
```

  *	Differences between small groups of genes - Probability that all pairwise odds ratios are greater/less than 1 (depending on the direction of the comparison) 
    * Cognitive impairment is less frequent in BBS3 patients compared to other patients (all canonical BBS genes).
```{r}
evaluator_prob_group_diff_all <- function(phenotype_name, group1, group2, group1_name = paste0(group1, collapse = "_"),group2_name = paste0(group2, collapse = "_")) {
    function (samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {

      target_column_name = paste0(phenotype_name,": ",bbs_labeller(group1_name)," more frequent than ", bbs_labeller(group2_name))
      samples_diff %>% 
        filter(phenotype == phenotype_name, gene.x %in% group1, gene.y %in% group2) %>%
        group_by(sample) %>%
        summarise(all_higher = all(odds_ratio >= 1)) %>%
        ungroup() %>%
        summarise(!!target_column_name := mean(all_higher))   
    }
}

evaluators[["CI_BBSO3_all"]] <- evaluator_prob_group_diff_all("CI", paste0("BBS0", c(1,2,4,5,7,8,9)), "BBS03", group1_name = "BBSome")
```

    * Cognitive impairment is more frequent in BBS7 patients compared to other patients wirh mutations in BBSome subunits.
```{r}
evaluators[["CI_BBS07_all"]] <-  evaluator_prob_group_diff_all("CI", "BBS07", paste0("BBS0", c(1,2,4,5,8,9)), group2_name = "others")

```
  
    *	Renal involvement is less frequent in BBS1, BBS4 and BBS8 patients compared to BBS2, BBS7, BBS9 patients.
```{r}
evaluators[["REN_groups_all"]] <- evaluator_prob_group_diff_all("REN", paste0("BBS0", c(2,7,9)),  paste0("BBS0", c(1,4,8)), group1_name = "BBS2,7,9", group2_name = "BBS1,4,8")
```
    *	Patients with BBS2 mutations are more likely to have heart anomalies compared to patients with other BBSome mutations.
```{r}
evaluators[["HEART_BBS2_all"]] <-  evaluator_prob_group_diff_all("HEART", "BBS02", paste0("BBS0", c(1,4,5,7,8,9)), group2_name = "others")
```
    *	Patients with BBS5 mutations are more likely to have liver anomalies compared to patients with other BBSome mutations.
```{r}
evaluators[["LIVER_BBS5_all"]] <-  evaluator_prob_group_diff_all("LIV", "BBS05", paste0("BBS0", c(1,2,4,7,8,9)), group2_name = "others")
```
    *	Patients with BBS4 mutations are less likely to have liver anomalies compared to patients with other BBSome mutations.

```{r}
evaluators[["LIVER_BBS4_all"]] <-  evaluator_prob_group_diff_all("LIV", paste0("BBS0", c(1,2,5,7,8,9)), "BBS04", group1_name = "others")
```  
  
  *	Individual differences in phenotype between two genes: directly the probability that the OR > 1 for patients with cLOF mutation.
    * Polydactyly is more frequent in BBS2 patients compared to BBS1 patients.
```{r}
evaluator_prob_pairwise_diff <- function(phenotype_name, gene_more_frequent, gene_less_frequent) {
  function (samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
     target_column_name = paste0(phenotype_name,": ", bbs_labeller(gene_more_frequent), " more frequent than ", bbs_labeller(gene_less_frequent))
      samples_diff %>% 
        filter(phenotype == phenotype_name, gene.x == gene_more_frequent, gene.y == gene_less_frequent) %>%
        group_by(sample) %>%
        summarise(all_higher = all(odds_ratio >= 1)) %>%
        ungroup() %>%
        summarise(!!target_column_name := mean(all_higher))   
  }
}

evaluators[["PD_BBS02_BBS01"]] <- evaluator_prob_pairwise_diff("PD","BBS02","BBS01")
```

    * Polydactyly is more frequent in BBS10 patients compared to BBS1 patients
```{r}
evaluators[["PD_BBS10_BBS01"]] <- evaluator_prob_pairwise_diff("PD","BBS10","BBS01")

```

    *	Renal involvment is less frequent in BBS1 patients compared to BBS2 patients.
```{r}
evaluators[["REN_BBS1_BBS2"]] <- evaluator_prob_pairwise_diff("REN","BBS02","BBS01")
```
    *	Renal involvment is less frequent in BBS1 patients compared to BBS10 patients.
```{r}
evaluators[["REN_BBS1_BBS10"]] <- evaluator_prob_pairwise_diff("REN","BBS10","BBS01")
```
    *	Liver involvment is less frequent in BBS1 patients compared to BBS2 patients.
```{r}
evaluators[["LIV_BBS1_BBS2"]] <- evaluator_prob_pairwise_diff("LIV","BBS02","BBS01")
```
    *	Liver involvment is less frequent in BBS1 patients compared to BBS10 patients.
```{r}
evaluators[["LIV_BBS1_BBS10"]] <- evaluator_prob_pairwise_diff("LIV","BBS10","BBS01")
```
    


# Bayesian Comparison

```{r compute_evaluation}
models_for_test <- all_models[c("gene_source_lof","gene_source_filtered_lof","gene_imputed_age_sex")]

evaluation <- all_models %>% 
#evaluation <- models_for_test %>%
 map_df(function(def) {
    fit <- all_fits[[def$name]]
    data_for_prediction <- data_for_prediction_base_model(def, genes_to_show, phenotypes_to_show, age_transform = age_transform_from_age(data$age_numbers_groups_guessed))
    
    data_for_prediction_bbsome <- data_for_prediction %>% filter_for_BBSome()
    
    samples <- get_tidy_samples(fit, data_for_prediction)
    samples_diff <- get_samples_pairwise_diff(def, samples) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    
    samples_diff_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome) %>% get_samples_pairwise_diff(def, .) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    
    samples_prediction_bbsome = get_tidy_samples_prediction(fit, data_for_prediction_bbsome)
    
    samples_linear_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome, scale = "linear")
    
    lof_evaluation <- evaluator_lof(def, fit)
    
    evaluators %>% map(function(evaluator) {
      evaluator(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome)
    }) %>% 
      do.call(cbind, .) %>% cbind(lof_evaluation, .) %>%
      mutate(model_name = def$name)
})

```


```{r load_freqentist}
#Freq. conclusions contain order
freq_conclusions <- readr::read_csv(here("private_data","BBS - Frequentist conclusions - p.csv"), col_types = cols(
  Conclusion = col_character(),
  `p-value-all` = col_double(),
  `p-value-cLOF` = col_double(),
  order = col_integer()
))


freq_conclusions_order <- order(freq_conclusions$order)
freq_conclusions <- freq_conclusions %>% 
  mutate(Conclusion = factor(Conclusion, levels = rev(Conclusion[freq_conclusions_order]))) %>%
  gather("model_name","p", `p-value-all`, `p-value-cLOF`) %>%
  mutate(model_nice = paste0("frequentist ", gsub("p-value-","", model_name)), Category = "Freq.")
```

```{r, fig.width = 8, fig.height = 4.5}
nice_model_name <- function(x)  {
  x %>% gsub("only","none", .) %>% 
    gsub("lof_per_gene","cLOF (by gene)", .) %>% 
    gsub("lof","cLOF", .) %>% 
    gsub("gene_","",.) %>% gsub("filtered_","filtered ", .) %>%
    gsub("very_narrow","very narrow", .) %>% 
    gsub("cor"," corr.", .) %>% 
    gsub("imputed_","imputed ", .) %>%  gsub("_"," + ", .)
}

conclusion_names <- names(evaluation)[names(evaluation) != "model_name"]

if(!identical(sort(levels(freq_conclusions$Conclusion)), sort(conclusion_names))) {
  print(setdiff(levels(freq_conclusions$Conclusion), conclusion_names))
  print(setdiff(conclusion_names, levels(freq_conclusions$Conclusion)))
  stop("Conclusions mismatch")
}


evaluation_processed <- evaluation %>% 
  mutate(model_nice = factor(nice_model_name(model_name), levels = c(
   nice_model_name(names(all_models))
  ))) %>%
  gather("Conclusion","Probability", -model_name, -model_nice) %>%
  mutate(Conclusion = factor(Conclusion, levels = levels(freq_conclusions$Conclusion)),
         Category = case_when(model_name %in% c("gene_source", "gene_source_lof", "gene_source_filtered_lof") ~ "Main",
                              model_name %in% c("gene_only", "gene_lof", "gene_lof_per_gene", "gene_only_filtered_lof") ~ "Bad fits", 
                              TRUE ~ "Secondary") %>% factor(levels = c("Main","Secondary","Bad fits")))

plots_na_color <- "#606060"

build_conclusion_plot <- function(evaluation_processed, categories = TRUE) {
  if(categories) {
    facet <- facet_grid(.~Category, scales = "free_x", space = "free_x") 
  } else {
    facet <- NULL
  }

  evaluation_processed %>%
    ggplot(aes(x = model_nice, y = Conclusion, fill = Probability, colour = "")) + geom_tile() + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5)) + 
      scale_fill_gradientn("Posterior prob.", colours = c("#1b7837","#f0f0f0", "#f0f0f0", "#762a83"),
                           values = c(0, 0.25,0.75,1),  limits = c(0,1), na.value = plots_na_color) +
      scale_x_discrete("Model components/modifications besides gene") +
      scale_colour_manual(values=NA) +              
      #Using color scale to create legend for NA
      (if(any(is.na(evaluation_processed$Probability))) {
        guides(fill = guide_colorbar(order = 10), colour=guide_legend("ND", override.aes=list(colour=plots_na_color, fill = plots_na_color))) 
      } else { 
        guides(colour = FALSE)
      }
      ) +
      facet + base_theme
}

conclusions_plot <- build_conclusion_plot(evaluation_processed)
conclusions_plot

```

Heatmap of posterior probability of statements characterizing individual conclusions. All Bayesian models include gene as covariate but may also include additional covarietes: source, age, sex and certain loss of function (cLOF) - either as a global covariete or by gene. Since age and sex are not available for all data, we can either fit the model only to patients where those are reported (filtered) or impute missing data (imputed). Instead of using cLOF as a covariate, we can fit the model using only patients with cLOF mutations (filtered cLOF). For most models we include a correlation structure across phenotypes (e.g., that two phenotypes occur frequently together across all genes), but this structure may be absent (no corr.) or replaced with a correlation structure across genes (gene corr. - e.g., that two genes have similar pattern of effects across all phenotypes). We also tried modifying the width of prior distributions (wide, narrow, very narrow). See supplementary material for a detailed description of all models and the imputation procedure. Dark grey indicates that the question could not be evaluated for the given model (currently only asking for cLOF differences in models that exclude cLOF). The "Bad fits" category is reserved for models we now fit the data badly, as discussed in Appendix 4.

Some patterns to notice:

* When fitting filtered datasets, there is less certainty implying less strong evidence in both directions
* Using very narrow priors on gene coefficients ($N(0,0.1)$, i.e. that almost all odds ratios should be less than $\sim 1.2$) unsurprisingly results in little evidence for directional differences between genes.
* Other than that the conclusions are not sensitive to model choice.

# Combining with frequentist results

```{r}
build_freq_conclusions_plot <- function(freq_conclusions, categories = TRUE) {

  significance_pos <- 1 - (log10(0.05) / log10(min(freq_conclusions$p, na.rm = TRUE)))
  
  if(categories) {
    facet <- facet_grid(.~Category, scales = "free_x", space = "free_x") 
  } else {
    facet <- NULL
  }
  
  freq_conclusions %>% ggplot(aes(x = model_nice, y = Conclusion, fill = p)) + geom_tile() + 
      theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5)) + 
      scale_fill_gradientn("p-value", 
                           colours = c("#7f0000", "#fdd49e","#f0f0f0", "#f0f0f0"),
                           values = c(0, significance_pos - 0.01, significance_pos, 1), 
                           trans = "log10",
                           breaks = c(1e-8,1e-4,0.05), labels = c("1e-8","1e-4","0.05"),
                           na.value = plots_na_color) +
      scale_x_discrete("Freq. type") +
      guides(fill = guide_colorbar(reverse = TRUE)) +
      expand_limits(fill = 1) +
      facet + base_theme
}

freq_conclusions_plot <-  build_freq_conclusions_plot(freq_conclusions)

freq_conclusions_plot
```

Heatmap of p-values from frequentist analysis from the same conclusions.

```{r, fig.width= 9, fig.height=4.5}
build_combined_conclusions_plot <- function(freq_conclusions_plot, conclusions_plot, rel_widths_plots, rel_widths_legend, rel_heights_legend) {
  hide_guide_theme <- theme(legend.position = 'none')
  hide_y_axis_theme <- theme(axis.title.y = element_blank(), 
                             axis.text.y = element_blank(), 
                             axis.line.y = element_blank(),
                             axis.ticks.y = element_blank())
  
  plot_grid(
    plot_grid(freq_conclusions_plot + hide_guide_theme + theme(plot.margin = margin(7,0,7,7, "pt")), 
              conclusions_plot + hide_y_axis_theme + hide_guide_theme + theme(plot.margin = margin(7,7,7, 0, "pt")), 
              align = "h",rel_widths = rel_widths_plots),
    plot_grid(
      cowplot::get_legend(freq_conclusions_plot), 
      cowplot::get_legend(conclusions_plot),
      ncol = 1, nrow = 3, rel_heights = rel_heights_legend),
    rel_widths = rel_widths_legend
  )
}

combined_conclusions_plot <- build_combined_conclusions_plot(freq_conclusions_plot, conclusions_plot, rel_widths_plots = c(1, 1.1), rel_widths_legend = c(4,1), rel_heights_legend = c(1,1.9,0.5)) 
combined_conclusions_plot
```

This is a combined plot for both frequentist and Bayesian analzsis, once again shown mostly consistent results even when frequentist analyses are taken into account. The only big difference is that some of the HEART and LIV conclusions are not supported by most Bayesian analyses, or only those ignoring between-study variability.

Finally a brief summary of the main analyses as shown in the main paper.

```{r fig.width=7, fig.height=3.8}
hide_titles_theme <- theme(axis.title.x = element_blank())

combined_conclusions_main_plot <- build_combined_conclusions_plot(
  build_freq_conclusions_plot(freq_conclusions %>% filter(model_nice == "frequentist all") %>% mutate(model_nice = "frequentist")
                              , categories = FALSE) + hide_titles_theme,
  build_conclusion_plot(evaluation_processed %>% filter(model_name == "gene_source_lof") 
                        %>% mutate(model_nice = "Bayesian")
                        ,
                        categories = FALSE) + hide_titles_theme,
  rel_widths_plots = c(9.2,1),
  rel_widths_legend = c(1,1),
  rel_heights_legend = c(1,1.5,0.5)
)

combined_conclusions_main_plot
```


```{r}
combined_conclusions_plot %>% ggsave(here("tmp_pics","conclusions.pdf"), ., width = 9, height = 4.5)
combined_conclusions_main_plot %>% ggsave(here("tmp_pics","conclusions_main.pdf"), ., width = 7, height = 3.8)
```

# Original Computing Environment

```{r}
sessionInfo()
```

