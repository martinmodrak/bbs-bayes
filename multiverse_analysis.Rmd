---
title: "Additional multiverse analysis"
output: html_notebook
---

TODO: 
- Rozdily v RD zmizi pri imputation Sex
- min_probable_OR ma divný scale
- podivat se na "divne" geny (případně vyhodit)

Text:
- Upravit text o filtraci (vyrazene fenotypy) - nebo spustit jeste nekdy se vsemi feno...
- Extremely skeptical prior is required to make a small portion of the 95% intervals not


This describes all Bayesian models we tried throughout this project. 

Further we discuss the reasoning behind our choice of model for the main analysis, in particular why between-study variability is crucial while age, sex and loss of function can be omitted.


Finally we compute how the conclusions of the paper hold under all of the models.

# Model description

All models are logistic regression using `brms`.

```{r setup}
library(rstan)
library(brms)
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
library(skimr)
library(readxl)
library(here)
library(mice)
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(cowplot)

source(here("data_processing.R"))
source(here("models.R"))
source(here("models_funcs.R"))
source(here("plots.R"))

##PP Checks take time, so turn this off for quicker computation of the rest
compute_pp_checks <- FALSE
```


```{r load_data}
data <- read_main_data()
genes_to_show <- genes_to_show_from_data(data)
data_long <- data_long_from_data(data)
```

## Base models

Base models are those that work with (a subset of) the original dataset, without any imputation. The models are defined in file `models.R`. They differ in the model formula, subsets of the dataset they use and priors for model coefficients. Here is the list of base models.

```{r}
models_base %>% map_df(function(def) {
  tibble(name = def$name, formula = as.character(def$formula)[1], filter = def$filter,  note = def$note)
})
```


```{r fit_base_models}
fits_base <- models_base %>%
  map(function(def) {
     fit_base_model(def, data_long)
  }
) 
```


```{r}
# data_for_prediction_gene_only <- tibble(gene = genes_to_show) %>%
#     crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))
# 
# data_for_prediction_gene_only_BBSome <- data_for_prediction_gene_only %>% filter(functional_group_for_gene(gene) == "BBSome", gene != "BBS18")
# 
# 
# data_for_prediction_gene_source <- tibble(gene = genes_to_show, source = "new_source") %>%
#     crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))
# 
# data_for_prediction_gene_source_BBSome <- data_for_prediction_gene_source %>% filter(functional_group_for_gene(gene) == "BBSome", gene != "BBS18")
# 
# data_long_filter_lof <- data_long %>% filter(loss_of_function == "certain")
# 
# data_for_prediction_gene_source_lof <- tibble(gene = genes_to_show, source = "new_source", loss_of_function_certain = 1) %>%
#     crossing(tibble(phenotype = phenotypes_to_show)) %>% mutate(functional_group = functional_group_for_gene(gene))
# 
# plot_pairwise_differences(fit_gene_source_age_imputed, data_for_prediction_gene_source_BBSome %>% crossing(age_std_for_model = age_transform(c(10,30,50))))
# 
# plot_pairwise_differences(fit_gene_source_age_sex_imputed, data_for_prediction_gene_source_BBSome %>% crossing(tibble(Sex = c("M","F"))) %>% crossing(age_std_for_model = age_transform(c(10,30,50))))

```

```{r}
# fit <- fit_base_model(models_base$gene_source_filtered_sex, data_long)
# data_for_prediction <- data_for_prediction_base_model(models_base$gene_source_filtered_age, genes_to_show, phenotypes_to_show)
# 
# plot_gene_phenotype_differences_estimates(fit, data_for_prediction)
```




## Imputation with mice

Including age or sex in the base models is problematic as it involves tossing out `r round(100 * mean(is.na(data$age)))`% or `r round(100 * mean(is.na(data$Sex)))`% of data respectively. This results in wide posterior intervals and weak inferences. To try to ameliorate this we also tested running models on datasets with age and sex imputed, using multiple imputation via the `mice` package. We assume that both age and sex can be realted to the functional group of the mutation and to each other. Involving further relations (e.g. individual genes) led to warnings from the `mice` package and we thus didn't use those.

```{r mice_impute}
set.seed(20181217)
predictor_matrix <- matrix(0, nrow = 2, ncol = ncol(data))
colnames(predictor_matrix) <- names(data)

predictor_matrix[, c("functional_group")] <- 1
predictor_matrix[1, c("Sex")] <- 1
predictor_matrix[2, c("age_std_for_model")] <- 1

mice_m = 5
data_mice <- mice(data, m = mice_m, blocks = list("age_std_for_model", "Sex"), predictorMatrix = predictor_matrix)
if(!is.null(data_mice$loggedEvents)) {
  data_mice$loggedEvents %>% select(dep, meth, out) %>% distinct()
}

data_long_mice <- mice::complete(data_mice, "all") %>% map(data_long_from_data)
```

The models differ in the formulas used, but all use the default priors and do not filter the dataset in any way.

## Fit the imputed models

```{r fit_imputed_models}
fits_imputed <- models_imputed %>% map(function(def) { fit_imputed_model(def, data_long_mice)})
all_fits <- c(fits_base, fits_imputed)
```


# Between-study variability needs to be included

# Between-study variability mostly explains age and sex differences

# Between-study variability mostly explains loss-of-function differences

## PP Check for LOF

```{r}
compare_pp_check <- function(model_names, pp_check_types) {
  for(name in model_names) {
    run_pp_checks(all_models[[name]], all_fits[[name]], data_long, types = pp_check_types)  
  }
} 
```


```{r, fig.width=8}
models_to_compare = c("gene_source", "gene_source_lof", "gene_source_filtered_lof", "gene_lof")

if(compute_pp_checks) {
  compare_pp_check(models_to_compare, c("gene_lof"))
}
```

First, let us note that the checks for `gene_source` and `gene_source_lof` are almost identical. So let us focus on the comparison between `gene_source` and `gene_source_filtered_lof`.

What we see is that the `gene_source` model has trouble explaining some properties of unknown.BBS01, BBS02, unknown.BBS03, certain.BBS06 (just barely), certain.BBS07, certain.BBS08 (just barely), certain.BBS10, unknown.BBS12, certain.other.

`gene_source_filtered_lof` only slightly improves over this some of the problematic genes became barely OK and others stayed the same (obviously it does not model the uncertain LOF data).

`gene_lof` improves in certrain.BBS08 and certain.other while having problems with unknown.BBS09 (barely) and with slightly worse fit for unnknown.BBS03, unknown.BBS07.

So while there improvements in fitting LOF differences per gene when including LOF in the model, they are not very strong.

```{r}
if(compute_pp_checks) {
  compare_pp_check(models_to_compare, c("phenotype_lof"))
}
```

Once again `gene_source` and `gene_source_lof` are almost identical. Overall the phenotype comparison is worse for the `gene_source` model as it has problems with OBE (barely), certain.CI (barely), REN, LIV, while `gene_source_filtered_lof` has no problems. `gene_lof` is similar to `gene_source` but improves for LIV.

The substantial problems with fitting REN in `gene_source` are potentially troubling.

This nevertheless indicates that there is some missing information in all fits.

```{r, fig.width=8}
if(compute_pp_checks) {
  compare_pp_check(models_to_compare, c("source"))
}
```

`gene_source` and `gene_source_lof` are once again almost identical.

The comparison between `gene_source` and `gene_lof` is not clear as for sources there is improvement in one and for some in the other.

`gene_source_filtered_lof` removes some of the issues in `gene_source` (e.g. Scheidecker et al. 2013), but retains others (Chaki et al., Schaefer et al. 2011 (a), Schaefer et al. 2016.).

Once again there is a minor advantage in filtering out LOF data.

```{r, fig.width=10, fig.height=7}
plot_pairwise_differences(models_base$gene_source_filtered_lof, fits_base$gene_source_filtered_lof, data_for_prediction_base_model(models_base$gene_source_filtered_lof, genes_to_show, phenotypes_to_show) %>% filter_for_BBSome())
```


TODO

In most cases, the loss of function does not make for a big difference in predictions. This is because there is no strong distinction in the data itself:

```{r, fig.width=8, fig.height=4}
lof_data_plot <- data_long %>% 
  group_by(source, phenotype, gene, loss_of_function) %>% 
  filter(functional_group == "BBSome", gene != "BBS18") %>%
  summarise(n_patients = length(phenotype_value), proportion = sum(phenotype_value) / n_patients) %>%
  ggplot(aes(x = gene, y = proportion, size = n_patients, color = loss_of_function)) +
  geom_jitter(alpha = 0.3, height = 0, width = 0.2) +
  facet_wrap(~phenotype, nrow = 2) +
  scale_y_continuous("Proportion of phenotype") +
  scale_size_continuous(range = c(0.5,4)) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5))

lof_data_plot
```

# Robustness of conclusions to model choice

Definovat min. klin. relevantni efekt

```{r}
min_interesting_effect <- 2
min_phenotypes_for_diffs <- 3
min_bbsome_pairwise_for_diffs <- 5

evaluators <- list()
```



*	The severity of BBS is worse in patients with LOF mutations than in patients with other mutations. 
  * Nutno rozmyslet, co to znamená pro modely, které neberou LOF v potaz - asi lze vzít predikci napřič pacienty, to ale nedává moc smysl. Nebál bych se říct, že tohle nebude podpořeno.
  * Measured as widest central posterior credible interval that excludes OR 1.
*	The data suggest a difference between the severity of BBS in patients with mutations in different functional groups of genes.
  * Measured as posterior probability, that there is clinically relevant effect for at least `r min_phenotypes_for_diffs` phenotypes for at least 1/2 of pairwise gene comparisons.
  
```{r}
evaluator_functional_groups_differ <- function(group1, group2) {
  function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
    target_column_name = paste(group1,"and",group2,"differ")
    samples_diff %>% 
      filter(functional_group.x == group1, functional_group.y == group2) %>%
      group_by(sample, phenotype) %>%
      summarise(enough_pairwise_relevant = mean(is_relevant) >= 1/2) %>%
      group_by(sample) %>%
      summarise(enough_phenotype_relevant = sum(enough_pairwise_relevant) >= min_phenotypes_for_diffs) %>%
      ungroup() %>%
      summarise(!!target_column_name := mean(enough_phenotype_relevant))  
  }
}

evaluators[["bbs3_vs_bbsome"]] <- evaluator_functional_groups_differ("BBS03","BBSome")
evaluators[["bbs3_vs_chaperonins"]] <- evaluator_functional_groups_differ("BBS03","Chaperonins")
```
*	The data suggest a difference between the severity of BBS in patients with mutations in different BBSome subunits.
  * Measured as posterior probability, that there is clinically relevant effect for at least `r min_phenotypes_for_diffs` phenotypes for at least `r min_bbsome_pairwise_for_diffs` pairwise comparisons. 
```{r}
evaluators[["bbsome_genes_differ"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
samples_diff_bbsome %>% 
  filter(as.character(gene.x) > as.character(gene.y)) %>%
  group_by(sample, phenotype) %>%
  summarise(enough_pairwise_relevant = sum(is_relevant) >= min_bbsome_pairwise_for_diffs) %>%
  group_by(sample) %>%
  summarise(enough_phenotype_relevant = sum(enough_pairwise_relevant) >= min_phenotypes_for_diffs)  %>%
  ungroup() %>%
  summarise(`BBSome genes differ` = mean(enough_phenotype_relevant))
}
```

```{r}
    # def <- models_base$gene_source
    # fit <- all_fits[[def$name]]
    # data_for_prediction <- data_for_prediction_base_model(def, genes_to_show, phenotypes_to_show, age_transform = age_transform_from_age(data$age_numbers_groups_guessed))
    # 
    # data_for_prediction_bbsome <- data_for_prediction %>% filter_for_BBSome()
    # 
    # samples <- get_tidy_samples(fit, data_for_prediction)
    # samples_diff <- get_samples_pairwise_diff(def, samples) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    # 
    # samples_diff_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome) %>% get_samples_pairwise_diff(def, .) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    # 
    # samples_prediction_bbsome = get_tidy_samples_prediction(fit, data_for_prediction_bbsome)
    # 
    # samples_linear_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome, scale = "linear")

```


*	BBS2 and BBS7 share similar pattern of penetrance of symptoms.
*	BBS4 phenotype is the most severe of all BBSome subunits.
  * Očekávám, že nebude potvrzeno (kvůli RD, OBE, PD)
  * Probability that BBS4 has top 3 odds ratios for at least 5 phenotypes
  * Probability that a patient with BBS4 has the most #phenotypes.
```{r}
evaluators[["bbs04_top"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
samples_diff_bbsome %>% 
    #TODO phenotype
  filter(gene.x == "BBS04", gene.y != "BBS04") %>%
  group_by(sample, phenotype) %>%
  summarise(bbs04_top = sum(odds_ratio < 1) <= 2) %>%
  group_by(sample) %>%
  summarise(bbs04_top_all = sum(bbs04_top) >= 5 ) %>%
  summarise(`BBS4 top odds` = mean(bbs04_top_all))
}
```
```{r}
evaluators[["bbs04_most_pheno"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
  samples_prediction_bbsome %>% 
    group_by(sample, gene) %>%
    summarise(num_phenotypes = sum(value)) %>%
    group_by(sample) %>%
    mutate(has_most_pheno = num_phenotypes >= max(num_phenotypes) ) %>%
    ungroup() %>%
    filter(gene == "BBS04") %>%
    #group_by(gene) %>%
    summarise(`BBS4 most #phenotypes` = mean(has_most_pheno))
}
```
*	Mutations in different BBSome subunits predispose to different renal phenotype.
  *  Measured as posterior probability, that there is clinically relevant effect for at least `r min_bbsome_pairwise_for_diffs` pairwise comparisons. 
```{r}
evaluators[["REN_bbsome_genes_differ"]] <- function(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
  samples_diff_bbsome %>% 
    filter(phenotype == "REN", as.character(gene.x) > as.character(gene.y)) %>%
    group_by(sample) %>%
    summarise(enough_pairwise_relevant = sum(is_relevant) >= min_bbsome_pairwise_for_diffs) %>%
    ungroup() %>%
    summarise(`REN - BBSome genes differ` = mean(enough_pairwise_relevant))
}
```

  
*	Polydactyly is more frequent in BBS2 patients compared to BBS1 patients.
  * Directly the probability that the OR > 1 (nebo OR > min. efekt)
```{r}
evaluator_prob_pairwise_diff <- function(phenotype_name, gene_more_frequent, gene_less_frequent) {
  function (samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {
     target_column_name = paste(phenotype_name, gene_more_frequent, "more likely than", gene_less_frequent)
      samples_diff %>% 
        filter(phenotype == phenotype_name, gene.x == gene_more_frequent, gene.y == gene_less_frequent) %>%
        group_by(sample) %>%
        summarise(all_higher = all(odds_ratio >= 1)) %>%
        ungroup() %>%
        summarise(!!target_column_name := mean(all_higher))   
  }
}

evaluators[["PD_BBS02_BBS01"]] <- evaluator_prob_pairwise_diff("PD","BBS02","BBS01")
```

*	Cognitive impairment is less frequent in BBS3 patients compared to other patients (all canonical BBS genes).
  * Tohle trochu dubluje tu diskuzi o func. groups
  * Probability that all pairwise odds are less
```{r}
evaluator_prob_group_diff_all <- function(phenotype_name, group1, group2, group1_name = paste0(group1, collapse = "_"),group2_name = paste0(group2, collapse = "_")) {
    function (samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome) {

      target_column_name = paste(phenotype_name,group1_name,"more likely than", group2_name)
      samples_diff %>% 
        filter(phenotype == phenotype_name, gene.x %in% group1, gene.y %in% group2) %>%
        group_by(sample) %>%
        summarise(all_higher = all(odds_ratio >= 1)) %>%
        ungroup() %>%
        summarise(!!target_column_name := mean(all_higher))   
    }
}

evaluators[["CI_BBSO3_all"]] <- evaluator_prob_group_diff_all("CI", paste0("BBS0", c(1,2,4,5,7,8,9)), "BBS03", group1_name = "BBSome")
```

*	Cognitive impairment is more frequent in BBS7 patients compared to other patients wirh mutations in BBSome subunits.
  * Očekávám, že nebude potvrzeno
```{r}
evaluators[["CI_BBS07_all"]] <-  evaluator_prob_group_diff_all("CI", "BBS07", paste0("BBS0", c(1,2,4,5,8,9)), group2_name = "others")

```

*	Renal involvement is less frequent in BBS1, BBS4 and BBS8 patients compared to BBS2, BBS7, BBS9 patients.
```{r}
evaluators[["REN_groups_all"]] <- evaluator_prob_group_diff_all("REN", paste0("BBS0", c(2,7,9)), paste0("BBS0", c(1,4,8)))
```

*	Renal involvment is less frequent in BBS1 patients compared to BBS2 patients.
```{r}
evaluators[["REN_BBS1_BBS2"]] <- evaluator_prob_pairwise_diff("REN","BBS02","BBS01")
```
*	Renal involvment is less frequent in BBS1 patients compared to BBS10 patients.
```{r}
evaluators[["REN_BBS1_BBS10"]] <- evaluator_prob_pairwise_diff("REN","BBS10","BBS01")
```
*	Liver involvment is less frequent in BBS1 patients compared to BBS2 patients.
```{r}
evaluators[["LIV_BBS1_BBS2"]] <- evaluator_prob_pairwise_diff("LIV","BBS02","BBS01")
```
*	Liver involvment is less frequent in BBS1 patients compared to BBS10 patients.
```{r}
evaluators[["LIV_BBS1_BBS10"]] <- evaluator_prob_pairwise_diff("LIV","BBS10","BBS01")
```
*	Patients with BBS2 mutations are more likely to have heart anomalies compared to patients with other BBSome mutations.
```{r}
evaluators[["HEART_BBS2_all"]] <-  evaluator_prob_group_diff_all("HEART", "BBS02", paste0("BBS0", c(1,4,5,7,8,9)), group2_name = "others")
```
*	Patients with BBS5 mutations are more likely to have liver anomalies compared to patients with other BBSome mutations.
```{r}
evaluators[["HEART_BBS5_all"]] <-  evaluator_prob_group_diff_all("HEART", "BBS05", paste0("BBS0", c(1,2,4,7,8,9)), group2_name = "others")
```
*	Patients with BBS4 mutations are less likely to have renal anomalies compared to patients with other BBSome mutations.

```{r}
evaluators[["HEART_BBS4_all"]] <-  evaluator_prob_group_diff_all("HEART", paste0("BBS0", c(1,2,5,7,8,9)), "BBS04", group1_name = "others")
```



```{r}
models_for_test <- all_models[c("gene_source","gene_source_filtered_lof","gene_imputed_age_sex")]

evaluation <- all_models %>% 
#evaluation <- models_for_test %>%
 map_df(function(def) {
    fit <- all_fits[[def$name]]
    data_for_prediction <- data_for_prediction_base_model(def, genes_to_show, phenotypes_to_show, age_transform = age_transform_from_age(data$age_numbers_groups_guessed))
    
    data_for_prediction_bbsome <- data_for_prediction %>% filter_for_BBSome()
    
    samples <- get_tidy_samples(fit, data_for_prediction)
    samples_diff <- get_samples_pairwise_diff(def, samples) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    
    samples_diff_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome) %>% get_samples_pairwise_diff(def, .) %>% mutate(is_relevant = odds_ratio >= min_interesting_effect | odds_ratio <= 1 /min_interesting_effect)
    
    samples_prediction_bbsome = get_tidy_samples_prediction(fit, data_for_prediction_bbsome)
    
    samples_linear_bbsome <- get_tidy_samples(fit, data_for_prediction_bbsome, scale = "linear")
    
    evaluators %>% map(function(evaluator) {
      evaluator(samples_diff, samples_diff_bbsome, samples_prediction_bbsome, samples_linear_bbsome)
    }) %>% 
      do.call(cbind, .) %>%
      mutate(model_name = def$name)
})

```

```{r, fig.width = 12}
conclusions_plot <- evaluation %>% 
  mutate(model_name = factor(model_name, levels = c(
   names(all_models)
  ))) %>%
  gather("Conclusion","Probability", -model_name) %>%
  mutate(Conclusion = factor(Conclusion, levels = rev(names(evaluation))),
         Category = case_when(model_name %in% c("gene_source","gene_source_filtered_lof") ~ "Main",
                              model_name %in% c("gene_only", "gene_lof", "gene_source_very_narrow") ~ "Bad fits", 
                              TRUE ~ "Secondary") %>% factor(levels = c("Main","Secondary","Bad fits"))) %>%
  ggplot(aes(x = model_name, y = Conclusion, fill = Probability)) + geom_raster() + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust =0.5)) + 
    #scale_fill_distiller("Posterior prob.", type = "div", palette = 3, limits = c(0,1)) +
    scale_fill_gradientn("Posterior prob.", colours = c("#1b7837","#f0f0f0", "#f0f0f0", "#762a83"),values = c(0, 0.25,0.75,1),  limits = c(0,1)) +
    facet_grid(.~Category, scales = "free_x", space = "free_x")

conclusions_plot

```

```{r}
conclusions_plot %>% ggsave(here("tmp_pics","conclusions.svg"), ., width = 12, height = 8)
```


```{r}
sessionInfo()
```

